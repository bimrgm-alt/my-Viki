<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ProdControl Pro - Compact</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      -webkit-font-smoothing: antialiased; 
      background-color: #020617;
      font-family: -apple-system, system-ui, sans-serif;
      overflow: hidden;
    }
    input, select { font-size: 16px !important; } 
    .ios-blur { backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
    .scroll-container { height: calc(100vh - 140px); overflow-y: auto; }
    .card-row { border-left: 3px solid transparent; transition: all 0.2s; }
    .card-row:active { background: #1e293b; }
    
    .search-result-item {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      color: #f8fafc;
      font-weight: 500;
      font-size: 13px;
    }
    .search-result-item:active {
      background-color: #4f46e5;
      color: white;
    }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
  </style>
</head>
<body class="text-slate-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const INITIAL_MASTER_DATA = [
    { name: 'Akabane133-24432-GB2',    qty: 20500, lots: 1, avgTime: 0.003   },
    { name: 'Akabane66-24432-028-3002', qty: 1930,  lots: 1, avgTime: 0.011   },
    { name: 'BOHSE 450',               qty: 30,    lots: 5, avgTime: 3.4     },
    { name: 'FUZISERA',                qty: 20,    lots: 3, avgTime: 4.0     },
    { name: 'FUZISERA-2',              qty: 50,    lots: 3, avgTime: 4.2     },
    { name: 'GOTOU-133-B19M10',        qty: 42,    lots: 1, avgTime: 4.55    },
    { name: 'GOTOU-66-B8M8F',          qty: 45,    lots: 1, avgTime: 6.15    },
    { name: 'KOMA',                    qty: 8,     lots: 2, avgTime: 5       },
    { name: 'KOBAYU',                  qty: 20,    lots: 1, avgTime: 3       },
    { name: 'KOYAUCHI',                qty: 237,   lots: 1, avgTime: 0.25    },
    { name: 'Katsumika',               qty: 400,   lots: 1, avgTime: 0.25    },
    { name: 'Khamida',                 qty: 4500,  lots: 3, avgTime: 0.1     },
    { name: 'MAEDA 8941712890',        qty: 3200,  lots: 1, avgTime: 0.037   },
    { name: 'MAEDA-3',                 qty: 8800,  lots: 1, avgTime: 0.027   },
    { name: 'MAEDA-45',                qty: 180000,lots: 1, avgTime: 0.00133 },
    { name: 'MAEDA-66',                qty: 40000, lots: 1, avgTime: 0.0118  },
    { name: 'NDN 77-45',               qty: 340,   lots: 1, avgTime: 0.29    },
    { name: 'NDN blue',                qty: 82,    lots: 1, avgTime: 0.25    },
    { name: 'NDN45',                   qty: 150,   lots: 1, avgTime: 0.27    },
    { name: 'SHINWA-10',               qty: 10,    lots: 1, avgTime: 4       },
    { name: 'SHINWA-36',               qty: 18,    lots: 1, avgTime: 3.8     },
    { name: 'SHINWA-6',                qty: 18,    lots: 3, avgTime: 5       },
    { name: 'Sugawara',                qty: 13,    lots: 1, avgTime: 6       },
    { name: 'Takao',                   qty: 2445,  lots: 1, avgTime: 0.040   },
    { name: 'Teppei PIN',              qty: 290,   lots: 1, avgTime: 0.28    },
    { name: 'Tokyo Rasen',             qty: 24,    lots: 1, avgTime: 3.75    },
    { name: 'Tousho Gearplate',        qty: 4127,  lots: 1, avgTime: 0.06    },
    { name: 'Toyo',                    qty: 460,   lots: 2, avgTime: 0.282   },
    { name: 'YAMASHITA',               qty: 50,    lots: 1, avgTime: 4.8     },
    { name: 'YASATO',                  qty: 270,   lots: 2, avgTime: 0.24    },
    { name: 'Yamamoto',                qty: 50,    lots: 1, avgTime: 3.9     },
    { name: 'Yoshida',                 qty: 195,   lots: 1, avgTime: 0.31    },
    { name: 'Yuu',                     qty: 13,    lots: 1, avgTime: 6       },
    { name: 'Yuu small',               qty: 10,    lots: 1, avgTime: 3.5     },
  ];

    const formatTime = (mins) => {
      const h = Math.floor((mins % 1440 + 1440) % 1440 / 60);
      const m = Math.floor(mins % 60);
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    };

    const formatDuration = (mins) => {
      const h = Math.floor(mins / 60);
      const m = Math.round(mins % 60);
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m`;
    };

    function App() {
      const [schedule, setSchedule] = useState([]);
      const [masterList, setMasterList] = useState(INITIAL_MASTER_DATA);
      const [startTime, setStartTime] = useState('08:00');
      const [searchTerm, setSearchTerm] = useState('');
      const [isSaving, setIsSaving] = useState(false);
      const [showSettings, setShowSettings] = useState(false);

      const [newProduct, setNewProduct] = useState({ name: '', qty: 0, lots: 1, avgTime: 0 });

      useEffect(() => {
        const saved = localStorage.getItem('pc_compact_v5');
        if (saved) {
          const d = JSON.parse(saved);
          setSchedule(d.schedule || []);
          setStartTime(d.startTime || '08:00');
          if (d.customMaster) {
            setMasterList([...INITIAL_MASTER_DATA, ...d.customMaster]);
          }
        } else {
          const p = INITIAL_MASTER_DATA[0];
          setSchedule([{ id: Date.now(), productName: p.name, qty: p.qty, lots: p.lots, gap: 60 }]);
        }
      }, []);

      const calculated = useMemo(() => {
        let current = (Number(startTime.split(':')[0]) * 60) + Number(startTime.split(':')[1]);
        return schedule.map(item => {
          const meta = masterList.find(p => p.name === item.productName) || masterList[0];
          const duration = Math.round(((item.qty * meta.avgTime) + ((item.lots - 1) * 10)) / 5) * 5;
          const start = current;
          const end = start + duration;
          current = end + (item.gap || 0);
          return { ...item, start: formatTime(start), end: formatTime(end), duration };
        });
      }, [schedule, startTime, masterList]);

      const save = () => {
        setIsSaving(true);
        const customItems = masterList.filter(m => !INITIAL_MASTER_DATA.some(i => i.name === m.name));
        localStorage.setItem('pc_compact_v5', JSON.stringify({ 
          schedule, 
          startTime,
          customMaster: customItems 
        }));
        setTimeout(() => setIsSaving(false), 500);
      };

      const addProductToSchedule = (pName) => {
        const p = masterList.find(x => x.name === pName);
        setSchedule([...schedule, { id: Date.now(), productName: p.name, qty: p.qty, lots: p.lots, gap: 60 }]);
        setSearchTerm('');
      };

      const handleAddMasterProduct = () => {
        if (!newProduct.name || masterList.some(p => p.name === newProduct.name)) return;
        setMasterList([...masterList, newProduct]);
        setNewProduct({ name: '', qty: 0, lots: 1, avgTime: 0 });
      };

      const deleteMasterProduct = (name) => {
        if (INITIAL_MASTER_DATA.some(p => p.name === name)) return;
        setMasterList(masterList.filter(p => p.name !== name));
      };

      const handleProductChange = (id, newName) => {
        const p = masterList.find(x => x.name === newName);
        setSchedule(schedule.map(s => s.id === id ? {
          ...s, 
          productName: newName, 
          qty: p.qty, 
          lots: p.lots 
        } : s));
      };

      const range = (start, stop, step = 1) => Array.from({ length: (stop - start) / step + 1 }, (_, i) => start + (i * step));

      return (
        <div className="flex flex-col h-screen max-w-md mx-auto bg-black relative">
          
          <header className="pt-10 pb-2 px-3 bg-slate-900/80 ios-blur border-b border-white/5 relative z-[100]">
            <div className="flex items-center gap-2">
              <input 
                type="time" 
                value={startTime} 
                onChange={e => setStartTime(e.target.value)}
                className="bg-indigo-600 text-white font-bold px-2 py-1 rounded text-xs w-20 outline-none"
              />
              <div className="relative flex-grow">
                <input 
                  className="w-full bg-white/10 border border-white/10 rounded-md py-1 px-3 text-xs text-white placeholder-slate-400 focus:bg-white/20 focus:ring-1 focus:ring-indigo-500 outline-none"
                  placeholder="Quick Add Search..."
                  value={searchTerm}
                  onChange={e => setSearchTerm(e.target.value)}
                />
                {searchTerm && (
                  <div className="absolute top-full left-0 right-0 mt-2 bg-slate-900 rounded-lg shadow-[0_10px_40px_rgba(0,0,0,0.8)] border border-white/20 max-h-60 overflow-y-auto overflow-x-hidden">
                    {masterList.filter(f => f.name.toLowerCase().includes(searchTerm.toLowerCase())).map(p => (
                      <div 
                        key={p.name} 
                        onClick={() => addProductToSchedule(p.name)} 
                        className="search-result-item truncate"
                      >
                        {p.name}
                      </div>
                    ))}
                  </div>
                )}
              </div>
              <button onClick={() => setShowSettings(!showSettings)} className="p-1.5 bg-slate-800 rounded-md border border-white/10 text-slate-300">
                 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
              </button>
              <button onClick={save} className={`text-[10px] font-bold px-3 py-1.5 rounded transition-colors ${isSaving ? 'bg-emerald-500 text-white' : 'bg-white text-black'}`}>
                {isSaving ? '✓' : 'SAVE'}
              </button>
            </div>
          </header>

          <main className="scroll-container p-2 space-y-1.5 custom-scrollbar pb-32">
            {calculated.map((item, idx) => (
              <div key={item.id} className="card-row bg-slate-900/50 border border-white/5 rounded-lg p-2 relative">
                <div className={`absolute left-0 top-0 bottom-0 w-1 rounded-l-lg ${idx % 2 === 0 ? 'bg-indigo-500' : 'bg-cyan-500'}`}></div>
                
                <div className="flex justify-between items-start mb-1 pl-1">
                  <select 
                    value={item.productName}
                    onChange={e => handleProductChange(item.id, e.target.value)}
                    className="bg-transparent text-[13px] font-bold text-white w-2/3 truncate outline-none"
                  >
                    {masterList.map(p => <option key={p.name} value={p.name} className="bg-slate-900">{p.name}</option>)}
                  </select>
                  <div className="flex flex-col items-end">
                    <div className="flex items-center gap-1 text-[13px] font-black">
                      <span className="text-emerald-400">{item.start}</span>
                      <span className="text-white/20">-</span>
                      <span className="text-orange-400">{item.end}</span>
                    </div>
                    <div className="text-[10px] font-bold text-slate-500">
                      {formatDuration(item.duration)}
                    </div>
                  </div>
                </div>

                <div className="flex items-center gap-2 pl-1">
                  <div className="flex items-center bg-white/5 rounded px-2 py-0.5 border border-white/5 flex-grow max-w-[120px]">
                    <span className="text-[8px] font-bold text-slate-500 mr-2 uppercase">Qty</span>
                    <input 
                      type="number" 
                      value={item.qty} 
                      onChange={e => setSchedule(schedule.map(s => s.id === item.id ? {...s, qty: parseInt(e.target.value)||0} : s))}
                      className="bg-transparent text-[11px] font-bold text-white w-full outline-none"
                    />
                  </div>
                  
                  <div className="flex items-center bg-white/5 rounded px-2 py-0.5 border border-white/5 min-w-[55px]">
                    <span className="text-[8px] font-bold text-slate-500 mr-2 uppercase">Lots</span>
                    <select 
                      value={item.lots} 
                      onChange={e => setSchedule(schedule.map(s => s.id === item.id ? {...s, lots: parseInt(e.target.value)} : s))}
                      className="bg-transparent text-[11px] font-bold text-white outline-none"
                    >
                      {range(1, 15).map(n => <option key={n} value={n} className="bg-slate-900">{n}</option>)}
                    </select>
                  </div>

                  <div className="flex items-center bg-white/5 rounded px-2 py-0.5 border border-white/5 min-w-[65px]">
                    <span className="text-[8px] font-bold text-slate-500 mr-2 uppercase">Gap</span>
                    <select 
                      value={item.gap} 
                      onChange={e => setSchedule(schedule.map(s => s.id === item.id ? {...s, gap: parseInt(e.target.value)} : s))}
                      className="bg-transparent text-[11px] font-bold text-white outline-none"
                    >
                      {range(10, 150, 10).map(m => <option key={m} value={m} className="bg-slate-900">{m}m</option>)}
                    </select>
                  </div>
                  <button onClick={() => setSchedule(schedule.filter(s => s.id !== item.id))} className="ml-auto text-slate-600 active:text-red-400 text-[14px] p-1 px-2">✕</button>
                </div>
              </div>
            ))}
          </main>

          {showSettings && (
            <div className="absolute inset-0 z-[200] bg-black/90 ios-blur flex flex-col p-4 animate-in fade-in slide-in-from-bottom-4 duration-200">
              <div className="flex justify-between items-center mb-6 pt-6">
                <h2 className="text-xl font-black text-white">Master Data Settings</h2>
                <button onClick={() => setShowSettings(false)} className="bg-white/10 p-2 rounded-full text-white">✕</button>
              </div>

              <div className="bg-slate-900 rounded-xl p-4 border border-white/10 mb-6">
                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Add New Product</h3>
                <div className="grid grid-cols-2 gap-3">
                  <div className="col-span-2">
                    <label className="text-[10px] text-slate-500 block mb-1">Product Name</label>
                    <input className="w-full bg-black border border-white/10 rounded px-3 py-2 text-sm text-white outline-none focus:border-indigo-500" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})} placeholder="e.g. Parts-99" />
                  </div>
                  <div>
                    <label className="text-[10px] text-slate-500 block mb-1">Standard Qty</label>
                    <input type="number" className="w-full bg-black border border-white/10 rounded px-3 py-2 text-sm text-white outline-none" value={newProduct.qty} onChange={e => setNewProduct({...newProduct, qty: parseInt(e.target.value)||0})} />
                  </div>
                  <div>
                    <label className="text-[10px] text-slate-500 block mb-1">Lots</label>
                    <input type="number" className="w-full bg-black border border-white/10 rounded px-3 py-2 text-sm text-white outline-none" value={newProduct.lots} onChange={e => setNewProduct({...newProduct, lots: parseInt(e.target.value)||1})} />
                  </div>
                  <div className="col-span-2">
                    <label className="text-[10px] text-slate-500 block mb-1">Avg Time (Mins per Unit)</label>
                    <input type="number" step="0.0001" className="w-full bg-black border border-white/10 rounded px-3 py-2 text-sm text-white outline-none" value={newProduct.avgTime} onChange={e => setNewProduct({...newProduct, avgTime: parseFloat(e.target.value)||0})} />
                  </div>
                  <button onClick={handleAddMasterProduct} className="col-span-2 bg-indigo-600 text-white font-bold py-3 rounded-lg mt-2 active:scale-95 transition-transform">ADD TO MASTER LIST</button>
                </div>
              </div>

              <div className="flex-grow overflow-y-auto custom-scrollbar">
                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Current Master Data</h3>
                {masterList.map((p, i) => (
                  <div key={i} className="flex items-center justify-between p-3 border-b border-white/5">
                    <div className="truncate pr-4">
                      <p className="text-sm font-bold text-white truncate">{p.name}</p>
                      <p className="text-[10px] text-slate-500">Qty: {p.qty} | Lots: {p.lots} | T: {p.avgTime}</p>
                    </div>
                    {!INITIAL_MASTER_DATA.some(orig => orig.name === p.name) && (
                      <button onClick={() => deleteMasterProduct(p.name)} className="text-red-500 text-xs font-bold p-2">DELETE</button>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="fixed bottom-6 left-4 right-4 max-w-md mx-auto z-50">
            <div className="flex justify-between items-end mb-4">
              <div className="bg-indigo-600/90 text-white px-4 py-2 rounded-2xl shadow-2xl ios-blur border border-white/20">
                <p className="text-[8px] font-black uppercase tracking-widest opacity-70">Shift Finish</p>
                <p className="text-xl font-black">{calculated.length ? calculated[calculated.length-1].end : '--:--'}</p>
              </div>
              
              <button 
                onClick={() => addProductToSchedule(masterList[0].name)}
                className="w-14 h-14 bg-white text-black rounded-full shadow-2xl flex items-center justify-center text-3xl font-light active:scale-90 transition-transform"
              >
                +
              </button>
            </div>

            <div className="text-center text-[7px] text-slate-600 uppercase tracking-[4px]">
              Regmi Bimal Production System
            </div>
          </div>

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>